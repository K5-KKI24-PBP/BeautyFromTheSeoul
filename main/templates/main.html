{% extends 'base.html' %}
{% load static %}
{% block content %}
{% include 'navbar.html' %}

<section class="ad-carousell">
  <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-indicators">
      <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
      {% for ad in ads %}
      <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="{{ forloop.counter }}" aria-label="Slide {{ forloop.counter|add:1 }}"></button>
      {% endfor %}
    </div>
    
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="{% static 'images/klairs_ad.png' %}" class="d-block w-100" alt="Default Ad" style="width: 700px; height: 500px; object-fit: cover;">
        <div class="carousel-caption d-none d-md-block">
        </div>
      </div>

      {% for ad in ads %}
      <div class="carousel-item">
        <img src="{{ ad.image }}" class="d-block w-100" alt="{{ ad.brand_name }}" style="width: 700px; height: 500px; object-fit: cover;">
        <div class="carousel-caption d-none d-md-block">
          {% if request.user.is_staff %}
            {% if not ad.is_approved %}
              <form method="post" action="{% url 'main:approve_ad' ad.pk %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">Approve</button>
              </form>
            {% endif %}
            <form method="post" action="{% url 'main:delete_ad' ad.pk %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Delete</button>
            </form>
            <a href="javascript:void(0);" onclick="openEditAdModal('{{ ad.pk }}', '{{ ad.brand_name }}', '{{ ad.image }}');">
              <button type="button" class="btn btn-warning">Edit</button>
            </a>            
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>

</section>


<section class="im-looking-for text-center mt-5 mb-5">
  <h1>I'M LOOKING FOR...</h1>
  <div class="container">
    <div class="row mt-4">

      <div class="col-md-3">
        <div class="card" style="width: 100%;">
          <div class="card-body">
            <p class="card-text">CLEANSER</p>
          </div>
          <img src="{% static 'images/klairs_ad.png' %}" class="card-img-bottom" alt="...">
        </div>
      </div>

      <div class="col-md-3">
        <div class="card" style="width: 100%;">
          <div class="card-body">
            <p class="card-text">TONER</p>
          </div>
          <img src="{% static 'images/klairs_ad.png' %}" class="card-img-bottom" alt="...">
        </div>
      </div>

      <div class="col-md-3">
        <div class="card" style="width: 100%;">
          <div class="card-body">
            <p class="card-text">SERUM</p>
          </div>
          <img src="{% static 'images/klairs_ad.png' %}" class="card-img-bottom" alt="...">
        </div>
      </div>

      <div class="col-md-3">
        <div class="card" style="width: 100%;">
          <div class="card-body">
            <p class="card-text">ESSENCE</p>
          </div>
          <img src="{% static 'images/klairs_ad.png' %}" class="card-img-bottom" alt="...">
        </div>
      </div>
    </div>
  </div>
</section>

<section class="on-budget">
  <a href="{% url 'events:event' %}" style="text-decoration: none; color: inherit;">
    <div class="container-fluid">
      <div class="row">

        <div class="col-md-6 p-0">
          <img src="{% static 'images/klairs_ad.png' %}" alt="On Budget" style="width: 100%; height: 100%; object-fit: cover;">
        </div>

        <div class="col-md-6 d-flex flex-column align-items-center justify-content-center" style="background-color: #6B94B3; color: #fff;">
          <h1>ON A BUDGET?</h1>
          <h4>RSVP for promotion events near you!</h4>
        </div>
      </div>
    </div>
  </a>
</section>


<section class="im-looking-for text-center mt-5 mb-5">
  <h1>I'M STRUGGLING WITH...</h1>
  <div class="container">
    <div class="row mt-3">

      <div class="col-md-4">
        <div class="card" style="width: 100%;">
          <div class="card-body">
            <p class="card-text">DARK CIRCLES</p>
          </div>
          <img src="{% static 'images/klairs_ad.png' %}" class="card-img-bottom" alt="...">
        </div>
      </div>

      <div class="col-md-4">
        <div class="card" style="width: 100%;">
          <div class="card-body">
            <p class="card-text">ACNE</p>
          </div>
          <img src="{% static 'images/klairs_ad.png' %}" class="card-img-bottom" alt="...">
        </div>
      </div>

      <div class="col-md-4">
        <div class="card" style="width: 100%;">
          <div class="card-body">
            <p class="card-text">DRY SKIN</p>
          </div>
          <img src="{% static 'images/klairs_ad.png' %}" class="card-img-bottom" alt="...">
        </div>
      </div>

    </div>
  </div>
</section>

<section class="spa-day">
  <div class="container-fluid">
    <div class="row">

      <div class="col-md-6 d-flex flex-column align-items-center justify-content-center" style="background-color: #6B94B3; color: #fff;">
        <h1>SPA DAY INCOMING?</h1>
        <h4>Pick out a face mask for you and your girls to enjoy!</h4>
      </div>

      <div class="col-md-6 p-0">
        <img src="{% static 'images/klairs_ad.png' %}" alt="On Budget" style="width: 100%; height: 100%; object-fit: cover;">
      </div>

    </div>
  </div>
</section>

<section class="stores-near text-center mt-5 mb-5">
  <a href="{% url 'locator:locator' %}"  style="text-decoration: none; color: inherit;">
    <h1 >BROWSE AT STORES NEAR YOU!</h1>
  </a>

  <div id="multiItemCarousel" class="carousel slide mt-4" data-bs-ride="carousel">
    <div class="carousel-inner">
      <!-- First slide with 4 items -->
      <div class="carousel-item active">
        <div class="row">
          <div class="col-md-3 px-2"> <!-- Added padding between columns -->
            <a href="https://g.co/kgs/YFcqSM9" target="_blank">
              <img src="{% static 'images/store1.jpg' %}" class="d-block w-100" alt="Store 1" style="height: 250px; object-fit: cover;">
            </a>
          </div>
          <div class="col-md-3 px-2">
            <a href="https://g.co/kgs/w5Dc9pq" target="_blank">
              <img src="{% static 'images/store2.jpg' %}" class="d-block w-100" alt="Store 2" style="height: 250px; object-fit: cover;">
            </a>
          </div>
          <div class="col-md-3 px-2">
            <a href="https://g.co/kgs/RqsESeV" target="_blank">
              <img src="{% static 'images/store3.jpg' %}" class="d-block w-100" alt="Store 3" style="height: 250px; object-fit: cover;">
            </a>
          </div>
          <div class="col-md-3 px-2">
            <a href="https://g.co/kgs/7284BCg" target="_blank">
              <img src="{% static 'images/store4.jpg' %}" class="d-block w-100" alt="Store 4" style="height: 250px; object-fit: cover;">
            </a>
          </div>
        </div>
      </div>

      <!-- Second slide with 4 more items -->
      <div class="carousel-item">
        <div class="row">
          <div class="col-md-3 px-2">
            <a href="https://g.co/kgs/oUGcQyc" target="_blank">
              <img src="{% static 'images/store5.jpg' %}" class="d-block w-100" alt="Store 5" style="height: 250px; object-fit: cover;">
            </a>
          </div>
          <div class="col-md-3 px-2">
            <a href="https://g.co/kgs/95Yqwnf" target="_blank">
              <img src="{% static 'images/store6.jpg' %}" class="d-block w-100" alt="Store 6" style="height: 250px; object-fit: cover;">
            </a>
          </div>
          <div class="col-md-3 px-2">
            <a href="https://g.co/kgs/32t4j6t" target="_blank">
              <img src="{% static 'images/store7.jpg' %}" class="d-block w-100" alt="Store 7" style="height: 250px; object-fit: cover;">
            </a>
          </div>
          <div class="col-md-3 px-2">
            <a href="https://g.co/kgs/w9STH52" target="_blank">
              <img src="{% static 'images/store8.jpg' %}" class="d-block w-100" alt="Store 8" style="height: 250px; object-fit: cover;">
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Carousel controls -->
    <button class="carousel-control-prev" type="button" data-bs-target="#multiItemCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#multiItemCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>
</section>


<section class="sun-protect">
    <div class="container-fluid">
      <div class="row">

        <div class="col-md-6 p-0">
          <img src="{% static 'images/klairs_ad.png' %}" alt="On Budget" style="width: 100%; height: 100%; object-fit: cover;">
        </div>

        <div class="col-md-6 d-flex flex-column align-items-center justify-content-center" style="background-color: #6B94B3; color: #fff;">
          <h1>PROTECT YOUR SKIN</h1>
          <h4>Browse our top picks for sun protection!</h4>
        </div>
      </div>
    </div>
</section>

<section class="ad-submission-box mt-4 mb-4">
<div class="card text-center mx-auto" style="background-color: #D9D9D9; color: #6B94B3; width: 726px; height: 200px; border-radius: 20px;"">
  <div class="card-body d-flex flex-column justify-content-center align-items-center">
    <h2 class="card-title">PARTNER UP WITH US!</h2>
    <p class="card-text">Want your brand to be showcased on our website?</p>
    <a href="{% url 'main:create_ad' %}">
      <button type="button" class="btn mt-2" style="background-color: #99D3FF; color: #FFFFFF;">SUBMIT YOUR ADS HERE!</button>
    </a>
  </div>
</div>
</section>

<!-- Edit Ad Modal -->
<div class="modal fade" id="editAdModal" tabindex="-1" aria-labelledby="editAdModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="editAdModalLabel">Edit Ad</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form id="editAdForm" method="post">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="brand_name" class="form-label">Brand Name</label>
                    <input type="text" class="form-control" id="brand_name" name="brand_name">
                </div>
                <div class="mb-3">
                    <label for="image" class="form-label">Image URL</label>
                    <input type="text" class="form-control" id="image" name="image">
                </div>
                <button type="submit" class="btn btn-primary">Save changes</button>
              </form>
          </div>
      </div>
  </div>
</div>


<script>
  function openEditAdModal(adId, brandName, imageUrl) {
    
    // Set form action and populate form fields
    document.getElementById('editAdForm').action = `/edit-ad/${adId}`;
    document.getElementById('brand_name').value = brandName || ''; 
    document.getElementById('image').value = imageUrl || '';

    // Show modal
    $('#editAdModal').modal('show');
  }

  // Handle AJAX form submission
  document.getElementById('editAdForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent standard form submission
    
    let formData = new FormData(this);
    let formDataObj = {};
    let csrftoken = "";

    // Add each pair to the object
    for (let [key, value] of formData.entries()) {
      if (key === "csrfmiddlewaretoken") {
        csrftoken = value;
      } else {
        formDataObj[key] = value;
      }
    }
    
    fetch(this.action, {
      method: 'POST',
      body: new URLSearchParams(formDataObj),
      headers: {
        'X-CSRFToken': csrftoken, // Add CSRF token here
        'X-Requested-With': 'XMLHttpRequest', // AJAX request header
      },
    })
    .then(response => {
      if (response?.ok) {
        $('#editAdModal').modal('hide');
        location.reload(); // Reload page to reflect changes
      } else {
        alert(response?.message || 'Error saving changes'); // Show error message from response
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while saving changes');
    });
  });
</script>

{% endblock content %}